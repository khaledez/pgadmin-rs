<div class="query-history-panel">
    <div class="history-header">
        <h4>Query History</h4>
        <button type="button" class="btn btn-icon btn-sm" onclick="clearQueryHistory()" title="Clear history">
            <span>üóëÔ∏è</span>
        </button>
    </div>

    <div id="history-stats" class="history-stats">
        <!-- Stats will be loaded here -->
    </div>

    <div id="history-list" class="history-list">
        <p class="text-muted text-sm">No queries yet. Execute a query to see history.</p>
    </div>
</div>

<style>
    .query-history-panel {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
        background: var(--color-surface);
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .history-header {
        padding: var(--space-md);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .history-header h4 {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .history-stats {
        padding: var(--space-sm);
        border-bottom: 1px solid var(--color-border);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-xs);
        font-size: 0.8rem;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        padding: var(--space-xs);
        background: var(--color-bg);
        border-radius: var(--radius-sm);
    }

    .stat-number {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--color-primary);
    }

    .stat-label {
        color: var(--color-text-muted);
        font-size: 0.7rem;
        margin-top: 2px;
    }

    .history-list {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-sm);
    }

    .history-item {
        padding: var(--space-sm);
        margin-bottom: var(--space-xs);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-sm);
        background: var(--color-bg);
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    .history-item:hover {
        background: var(--color-hover);
        border-color: var(--color-primary);
    }

    .history-item.success {
        border-left: 3px solid #4caf50;
    }

    .history-item.error {
        border-left: 3px solid #f44336;
    }

    .history-query {
        font-family: var(--font-mono);
        margin-bottom: var(--space-xs);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--color-text);
    }

    .history-meta {
        display: flex;
        gap: var(--space-sm);
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    .history-time {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .history-duration {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .history-rows {
        display: flex;
        align-items: center;
        gap: 2px;
    }

    .history-actions {
        display: flex;
        gap: var(--space-xs);
        margin-top: var(--space-xs);
    }

    .history-actions button {
        padding: 2px 6px;
        font-size: 0.75rem;
    }
</style>

<script>
    // Load and display query history
    async function loadQueryHistory() {
        try {
            const [historyResponse, statsResponse] = await Promise.all([
                fetch('/api/query/history'),
                fetch('/api/query/history/stats')
            ]);
            const entries = await historyResponse.json();
            const stats = await statsResponse.json();
            displayQueryHistory(entries);
            displayHistoryStats(stats);
        } catch (error) {
            console.error('Failed to load query history:', error);
        }
    }

    function displayHistoryStats(stats) {
        const statsContainer = document.getElementById('history-stats');
        if (!stats || stats.total_queries === 0) {
            statsContainer.innerHTML = '';
            return;
        }

        const successRate = stats.total_queries > 0 
            ? Math.round((stats.successful_queries / stats.total_queries) * 100) 
            : 0;

        statsContainer.innerHTML = `
            <div class="stat-item">
                <div class="stat-number">${stats.total_queries}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">${stats.successful_queries}</div>
                <div class="stat-label">Success</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">${stats.average_duration_ms}ms</div>
                <div class="stat-label">Avg Time</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">${stats.failed_queries}</div>
                <div class="stat-label">Failed</div>
            </div>
        `;
    }

    function displayQueryHistory(entries) {
        const historyList = document.getElementById('history-list');
        
        if (!entries || entries.length === 0) {
            historyList.innerHTML = '<p class="text-muted text-sm">No queries yet. Execute a query to see history.</p>';
            return;
        }

        historyList.innerHTML = entries.map(entry => `
            <div class="history-item ${entry.success ? 'success' : 'error'}">
                <div class="history-query" title="${entry.query}">
                    ${escapeHtml(entry.query.substring(0, 60))}${entry.query.length > 60 ? '...' : ''}
                </div>
                <div class="history-meta">
                    <div class="history-time">
                        <span>üïê</span>
                        <span>${formatTime(new Date(entry.executed_at))}</span>
                    </div>
                    <div class="history-duration">
                        <span>‚è±Ô∏è</span>
                        <span>${entry.duration_ms}ms</span>
                    </div>
                    ${entry.row_count !== null ? `
                        <div class="history-rows">
                            <span>üìä</span>
                            <span>${entry.row_count} rows</span>
                        </div>
                    ` : ''}
                </div>
                ${entry.error ? `<div class="text-danger text-sm mt-xs">${escapeHtml(entry.error.substring(0, 50))}</div>` : ''}
                <div class="history-actions">
                    <button type="button" class="btn btn-sm" onclick="useQuery('${escapeAttribute(entry.query)}')" title="Load this query">
                        üì• Load
                    </button>
                    <button type="button" class="btn btn-sm" onclick="copyQuery('${escapeAttribute(entry.query)}')" title="Copy query">
                        üìã Copy
                    </button>
                </div>
            </div>
        `).join('');
    }

    function useQuery(query) {
        document.getElementById('sql-input').value = query;
        document.getElementById('sql-input').focus();
        ToastManager.info('Query loaded. Press Ctrl+Enter to execute.');
    }

    function copyQuery(query) {
        const textarea = document.createElement('textarea');
        textarea.value = query;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            ToastManager.success('Query copied to clipboard!', 2000);
        } catch (err) {
            ToastManager.error('Failed to copy query');
        }
        document.body.removeChild(textarea);
    }

    function clearQueryHistory() {
        if (confirm('Clear all query history?')) {
            fetch('/api/query/history', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                loadQueryHistory();
                ToastManager.success('Query history cleared');
            })
            .catch(error => {
                console.error('Failed to clear history:', error);
                ToastManager.error('Failed to clear history');
            });
        }
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function escapeAttribute(text) {
        return text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    // Load history on page load
    document.addEventListener('DOMContentLoaded', loadQueryHistory);

    // Reload history after query execution
    document.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'query-results') {
            setTimeout(loadQueryHistory, 100);
        }
    });
</script>
