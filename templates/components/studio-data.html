<div class="flex flex-col h-full">
    <!-- Table Toolbar -->
    <div class="flex items-center justify-between px-3 py-2 bg-base-100 border-b border-base-300">
        <div class="flex items-center gap-3">
            <span class="font-mono text-sm font-bold text-accent">{{ schema }}.{{ table }}</span>
            <span class="badge badge-neutral badge-sm">{{ pagination.total_rows }} rows</span>
            {% if pk_column.is_none() %}
            <span class="badge badge-warning badge-xs" title="No primary key - editing disabled">Read-only</span>
            {% endif %}
        </div>
        <div class="flex items-center gap-1">
            {% if pk_column.is_some() %}
            <button class="btn btn-ghost btn-xs"
                    hx-post="/api/table/{{ schema }}/{{ table }}/row"
                    hx-target="#studio-content"
                    hx-swap="innerHTML"
                    hx-confirm="Add a new row with default values?"
                    title="Add Row">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add Row
            </button>
            {% endif %}
            <button class="btn btn-ghost btn-xs" 
                    hx-get="/api/studio/table/{{ schema }}/{{ table }}"
                    hx-target="#studio-content"
                    title="Refresh">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
            
            <!-- Export Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-xs">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Export
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-36 p-2 shadow-lg border border-base-300">
                    <li>
                        <form action="/api/query/export" method="POST">
                            <input type="hidden" name="query" value="SELECT * FROM &quot;{{ schema }}&quot;.&quot;{{ table }}&quot;">
                            <input type="hidden" name="format" value="csv">
                            <button type="submit" class="w-full text-left">CSV</button>
                        </form>
                    </li>
                    <li>
                        <form action="/api/query/export" method="POST">
                            <input type="hidden" name="query" value="SELECT * FROM &quot;{{ schema }}&quot;.&quot;{{ table }}&quot;">
                            <input type="hidden" name="format" value="json">
                            <button type="submit" class="w-full text-left">JSON</button>
                        </form>
                    </li>
                </ul>
            </div>
            
            <!-- View Structure -->
            <a href="/table/{{ schema }}/{{ table }}" 
               class="btn btn-ghost btn-xs"
               title="View Structure">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
                Structure
            </a>
        </div>
    </div>

    {% if rows.is_empty() %}
    <!-- Empty State -->
    <div class="flex-1 flex flex-col items-center justify-center text-base-content/50">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-2 opacity-30">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5m6 4.125l2.25 2.25m0 0l2.25 2.25M12 13.875l2.25-2.25M12 13.875l-2.25 2.25M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
        </svg>
        <p class="text-sm">No data in this table</p>
        {% if pk_column.is_some() %}
        <button class="btn btn-primary btn-sm mt-4"
                hx-post="/api/table/{{ schema }}/{{ table }}/row"
                hx-target="#studio-content"
                hx-swap="innerHTML">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Add First Row
        </button>
        {% endif %}
    </div>
    {% else %}
    <!-- Data Grid -->
    <div class="flex-1 overflow-auto">
        <table class="table table-xs table-pin-rows table-pin-cols w-full">
            <thead>
                <tr>
                    <th class="bg-base-200 w-12 text-center text-base-content/50">#</th>
                    {% for column in columns %}
                    <th class="bg-base-200 whitespace-nowrap">
                        <div class="flex items-center gap-1">
                            <span class="font-mono text-xs font-semibold">{{ column.name }}</span>
                            <span class="text-base-content/40 text-[10px] font-normal">{{ column.data_type }}</span>
                            {% if column.is_pk %}
                            <span class="badge badge-primary badge-xs">PK</span>
                            {% endif %}
                        </div>
                    </th>
                    {% endfor %}
                    {% if pk_column.is_some() %}
                    <th class="bg-base-200 w-10"></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr class="hover group">
                    <th class="bg-base-200 text-base-content/50 text-xs text-center">{{ loop.index }}</th>
                    {% for cell in row.cells %}
                    <td class="font-mono text-xs p-0">
                        {% if pk_column.is_some() && row.pk_value.is_some() %}
                        <div class="editable-cell cursor-pointer hover:bg-base-300 px-2 py-1 rounded transition-colors"
                             hx-get="/api/cell/edit?schema={{ schema }}&table={{ table }}&column={{ columns[loop.index0].name }}&pk_column={{ pk_column.as_ref().unwrap() }}&pk_value={{ row.pk_value.as_ref().unwrap() }}&data_type={{ columns[loop.index0].data_type }}"
                             hx-swap="outerHTML"
                             hx-trigger="click"
                             title="Click to edit">
                            {% match cell %}
                                {% when serde_json::Value::Null %}
                                    <span class="text-base-content/30 italic">NULL</span>
                                {% when serde_json::Value::String with (s) %}
                                    {% if s.is_empty() %}
                                        <span class="text-base-content/30">(empty)</span>
                                    {% else %}
                                        <span class="truncate max-w-xs block" title="{{ s }}">{{ s }}</span>
                                    {% endif %}
                                {% when serde_json::Value::Number with (n) %}
                                    <span class="text-accent text-right block">{{ n }}</span>
                                {% when serde_json::Value::Bool with (b) %}
                                    {% if b %}
                                        <span class="text-success">true</span>
                                    {% else %}
                                        <span class="text-error">false</span>
                                    {% endif %}
                                {% when serde_json::Value::Object with (_) %}
                                    <span class="badge badge-ghost badge-xs cursor-pointer">{...}</span>
                                {% when serde_json::Value::Array with (_) %}
                                    <span class="badge badge-ghost badge-xs cursor-pointer">[...]</span>
                                {% else %}
                                    <code class="text-xs">{{ cell }}</code>
                            {% endmatch %}
                        </div>
                        {% else %}
                        <!-- Read-only cell -->
                        <div class="px-2 py-1">
                            {% match cell %}
                                {% when serde_json::Value::Null %}
                                    <span class="text-base-content/30 italic">NULL</span>
                                {% when serde_json::Value::String with (s) %}
                                    {% if s.is_empty() %}
                                        <span class="text-base-content/30">(empty)</span>
                                    {% else %}
                                        <span class="truncate max-w-xs block" title="{{ s }}">{{ s }}</span>
                                    {% endif %}
                                {% when serde_json::Value::Number with (n) %}
                                    <span class="text-accent text-right block">{{ n }}</span>
                                {% when serde_json::Value::Bool with (b) %}
                                    {% if b %}
                                        <span class="text-success">true</span>
                                    {% else %}
                                        <span class="text-error">false</span>
                                    {% endif %}
                                {% when serde_json::Value::Object with (_) %}
                                    <span class="badge badge-ghost badge-xs">{...}</span>
                                {% when serde_json::Value::Array with (_) %}
                                    <span class="badge badge-ghost badge-xs">[...]</span>
                                {% else %}
                                    <code class="text-xs">{{ cell }}</code>
                            {% endmatch %}
                        </div>
                        {% endif %}
                    </td>
                    {% endfor %}
                    {% if pk_column.is_some() && row.pk_value.is_some() %}
                    <td class="bg-base-200 p-1">
                        <button class="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 text-error"
                                hx-delete="/api/table/{{ schema }}/{{ table }}/row/{{ row.pk_value.as_ref().unwrap() }}?pk_column={{ pk_column.as_ref().unwrap() }}"
                                hx-target="#studio-content"
                                hx-swap="innerHTML"
                                hx-confirm="Delete this row?"
                                title="Delete row">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                            </svg>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if pagination.total_pages > 1 %}
    <div class="flex items-center justify-between px-3 py-2 bg-base-100 border-t border-base-300">
        <span class="text-xs text-base-content/50">
            Page {{ pagination.page }} of {{ pagination.total_pages }}
        </span>
        <div class="join">
            <button class="join-item btn btn-xs"
                    {% if pagination.page == 1 %}disabled{% endif %}
                    hx-get="/api/studio/table/{{ schema }}/{{ table }}?page=1"
                    hx-target="#studio-content">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M18.75 19.5l-7.5-7.5 7.5-7.5m-6 15L5.25 12l7.5-7.5" />
                </svg>
            </button>
            <button class="join-item btn btn-xs"
                    {% if pagination.page == 1 %}disabled{% endif %}
                    hx-get="/api/studio/table/{{ schema }}/{{ table }}?page={{ pagination.page - 1 }}"
                    hx-target="#studio-content">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                </svg>
            </button>
            <button class="join-item btn btn-xs btn-active">{{ pagination.page }}</button>
            <button class="join-item btn btn-xs"
                    {% if pagination.page >= pagination.total_pages %}disabled{% endif %}
                    hx-get="/api/studio/table/{{ schema }}/{{ table }}?page={{ pagination.page + 1 }}"
                    hx-target="#studio-content">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                </svg>
            </button>
            <button class="join-item btn btn-xs"
                    {% if pagination.page >= pagination.total_pages %}disabled{% endif %}
                    hx-get="/api/studio/table/{{ schema }}/{{ table }}?page={{ pagination.total_pages }}"
                    hx-target="#studio-content">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 4.5l7.5 7.5-7.5 7.5m6-15l7.5 7.5-7.5 7.5" />
                </svg>
            </button>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
