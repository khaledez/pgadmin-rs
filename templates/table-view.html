{% extends "base.html" %}

{% block title %}{{ table_name }} - {{ schema_name }} - pgAdmin-rs{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Table Toolbar -->
    <div class="flex items-center justify-between px-4 py-2 bg-base-200 border-b border-base-300">
        <div class="flex items-center gap-3">
            <span class="font-mono font-bold text-sm text-accent">{{ schema_name }}.{{ table_name }}</span>
            <span class="badge badge-neutral badge-sm">{{ row_count }} rows</span>
        </div>
        <div class="flex items-center gap-1">
            <button class="btn btn-ghost btn-sm" 
                    hx-get="/api/schemas/{{ schema_name }}/tables/{{ table_name }}/data?page=1&page_size=50"
                    hx-target="#data-grid"
                    hx-swap="innerHTML"
                    title="Refresh">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                </svg>
            </button>
            <!-- Export Dropdown -->
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Export
                </div>
                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-40 p-2 shadow-lg border border-base-300">
                    <li>
                        <form action="/api/query/export" method="POST">
                            <input type="hidden" name="query" value="SELECT * FROM &quot;{{ schema_name }}&quot;.&quot;{{ table_name }}&quot;">
                            <input type="hidden" name="format" value="csv">
                            <button type="submit" class="w-full text-left">CSV</button>
                        </form>
                    </li>
                    <li>
                        <form action="/api/query/export" method="POST">
                            <input type="hidden" name="query" value="SELECT * FROM &quot;{{ schema_name }}&quot;.&quot;{{ table_name }}&quot;">
                            <input type="hidden" name="format" value="json">
                            <button type="submit" class="w-full text-left">JSON</button>
                        </form>
                    </li>
                    <li>
                        <form action="/api/query/export" method="POST">
                            <input type="hidden" name="query" value="SELECT * FROM &quot;{{ schema_name }}&quot;.&quot;{{ table_name }}&quot;">
                            <input type="hidden" name="format" value="sql">
                            <button type="submit" class="w-full text-left">SQL</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div role="tablist" class="tabs tabs-bordered bg-base-200 px-4">
        <input type="radio" name="table_tabs" role="tab" class="tab" aria-label="Data" checked 
               onclick="document.getElementById('data-panel').classList.remove('hidden'); document.getElementById('structure-panel').classList.add('hidden');" />
        <input type="radio" name="table_tabs" role="tab" class="tab" aria-label="Structure"
               onclick="document.getElementById('structure-panel').classList.remove('hidden'); document.getElementById('data-panel').classList.add('hidden');" />
    </div>

    <!-- Data Panel -->
    <div id="data-panel" class="flex-1 overflow-hidden flex flex-col">
        <!-- Data Grid -->
        <div id="data-grid" class="flex-1 overflow-auto"
             hx-get="/api/schemas/{{ schema_name }}/tables/{{ table_name }}/data?page=1&page_size=50"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div class="flex items-center justify-center h-full">
                <span class="loading loading-spinner loading-lg text-accent"></span>
            </div>
        </div>

        <!-- Query Bar (Collapsible) -->
        <div class="collapse collapse-arrow bg-base-200 border-t border-base-300">
            <input type="checkbox" /> 
            <div class="collapse-title text-sm font-medium py-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
                </svg>
                SQL Query
            </div>
            <div class="collapse-content">
                <form hx-post="/api/query/execute"
                      hx-target="#data-grid"
                      hx-swap="innerHTML"
                      class="flex flex-col gap-2">
                    <textarea name="query"
                              class="textarea textarea-bordered font-mono text-sm w-full"
                              placeholder="SELECT * FROM &quot;{{ schema_name }}&quot;.&quot;{{ table_name }}&quot; LIMIT 100;"
                              rows="3">SELECT * FROM "{{ schema_name }}"."{{ table_name }}" LIMIT 100;</textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" />
                            </svg>
                            Execute
                        </button>
                        <button type="reset" class="btn btn-ghost btn-sm">Clear</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Structure Panel -->
    <div id="structure-panel" class="flex-1 overflow-auto p-4 hidden">
        <!-- Columns Card -->
        <div class="card bg-base-100 shadow-sm mb-4">
            <div class="card-body p-4">
                <h3 class="card-title text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                    </svg>
                    Columns
                </h3>
                <div class="overflow-x-auto">
                    <table class="table table-xs table-zebra">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Nullable</th>
                                <th>PK</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for column in columns %}
                            <tr>
                                <td><code class="text-accent">{{ column.name }}</code></td>
                                <td class="font-mono text-xs text-base-content/70">{{ column.data_type }}</td>
                                <td>
                                    {% if column.is_nullable %}
                                    <span class="badge badge-success badge-xs">Yes</span>
                                    {% else %}
                                    <span class="badge badge-error badge-xs">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if column.is_pk %}
                                    <span class="badge badge-primary badge-xs">PK</span>
                                    {% else %}
                                    <span class="text-base-content/30">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if let Some(default) = &column.default %}
                                    <code class="text-xs">{{ default }}</code>
                                    {% else %}
                                    <span class="text-base-content/30">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Indexes Card -->
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body p-4">
                <h3 class="card-title text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                    </svg>
                    Indexes
                </h3>
                <div id="indexes-container"
                     hx-get="/api/table/{{ schema_name }}/{{ table_name }}/indexes"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <span class="loading loading-spinner loading-sm"></span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
