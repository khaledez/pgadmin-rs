{% extends "base.html" %}

{% block title %}Schema Browser - pgAdmin-rs{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Database Browser</h2>
        <p class="text-sm text-muted mt-md">Navigate your database structure</p>
    </div>

    <div class="flex gap-lg">
        <!-- Database List -->
        <div style="flex: 0 0 300px; border-right: 1px solid var(--color-border); padding-right: var(--space-lg);">
            <div class="flex justify-between align-center mb-md">
                <h3>Databases</h3>
                <button class="btn btn-sm" onclick="showCreateDatabaseModal()">+ New</button>
            </div>
            <div id="database-list"
                 hx-get="/api/databases"
                 hx-trigger="load"
                 hx-swap="innerHTML"
                 hx-indicator="#database-spinner">
                <p class="text-muted">Loading databases...</p>
            </div>
            <div class="spinner htmx-indicator" id="database-spinner"></div>
        </div>

        <!-- Schema List -->
        <div style="flex: 0 0 300px; border-right: 1px solid var(--color-border); padding-right: var(--space-lg);">
            <h3 class="mb-md">Schemas</h3>
            <div id="schema-list"
                 hx-get="/api/schemas"
                 hx-trigger="load"
                 hx-swap="innerHTML"
                 hx-indicator="#schema-spinner">
                <p class="text-muted">Loading schemas...</p>
            </div>
            <div class="spinner htmx-indicator" id="schema-spinner"></div>
        </div>

        <!-- Table List -->
        <div style="flex: 0 0 300px; border-right: 1px solid var(--color-border); padding: 0 var(--space-lg);">
            <h3 class="mb-md">Tables</h3>
            <div id="table-list"
                 hx-indicator="#table-spinner">
                <p class="text-muted">Select a schema to view its tables.</p>
            </div>
            <div class="spinner htmx-indicator" id="table-spinner"></div>
        </div>

        <!-- Table Details -->
        <div style="flex: 1; padding-left: var(--space-lg);">
            <div id="table-data-container"
                 hx-indicator="#details-spinner">
                <p class="text-muted">Select a table to view details.</p>
            </div>
            <div class="spinner htmx-indicator" id="details-spinner"></div>
        </div>
    </div>
</div>

<!-- Create Database Modal -->
<div id="create-database-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Database</h3>
            <button class="btn-close" onclick="hideCreateDatabaseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-database-form" onsubmit="createDatabase(event)">
                <div class="form-group">
                    <label for="db-name">Database Name *</label>
                    <input type="text" id="db-name" name="name" required
                           pattern="[a-zA-Z0-9_-]+"
                           maxlength="63"
                           placeholder="my_database">
                    <small class="text-muted">Letters, numbers, underscores, and hyphens only</small>
                </div>
                <div class="form-group">
                    <label for="db-owner">Owner (optional)</label>
                    <input type="text" id="db-owner" name="owner"
                           pattern="[a-zA-Z0-9_-]+"
                           placeholder="postgres">
                </div>
                <div class="flex gap-md justify-end mt-lg">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateDatabaseModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Database</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--color-bg);
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
}

.modal-body {
    padding: var(--space-lg);
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-muted);
    padding: 0;
    width: 30px;
    height: 30px;
}

.btn-close:hover {
    color: var(--color-text);
}

.form-group {
    margin-bottom: var(--space-md);
}

.form-group label {
    display: block;
    margin-bottom: var(--space-sm);
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: var(--space-sm);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    font-size: 0.9rem;
}

.form-group input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-group small {
    display: block;
    margin-top: var(--space-xs);
}
</style>

<script>
function showCreateDatabaseModal() {
    document.getElementById('create-database-modal').style.display = 'flex';
}

function hideCreateDatabaseModal() {
    document.getElementById('create-database-modal').style.display = 'none';
    document.getElementById('create-database-form').reset();
}

async function createDatabase(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        name: formData.get('name'),
        owner: formData.get('owner') || null
    };

    try {
        const response = await fetch('/api/databases/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            hideCreateDatabaseModal();
            // Refresh database list
            htmx.trigger('#database-list', 'load');
        } else {
            alert('Error: ' + (result.message || 'Failed to create database'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function confirmDeleteDatabase(dbName) {
    if (confirm(`Are you sure you want to delete database "${dbName}"? This action cannot be undone!`)) {
        deleteDatabase(dbName);
    }
}

async function deleteDatabase(dbName) {
    try {
        const response = await fetch('/api/databases/drop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: dbName })
        });

        const result = await response.json();

        if (response.ok) {
            alert(result.message);
            // Refresh database list
            htmx.trigger('#database-list', 'load');
        } else {
            alert('Error: ' + (result.message || 'Failed to drop database'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>
{% endblock %}
