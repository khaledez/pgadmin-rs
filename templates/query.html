{% extends "base.html" %}

{% block title %}Query Editor - pgAdmin-rs{% endblock %}

{% block head %}
<style>
    .editor-section {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .sql-editor-wrapper {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .sql-editor {
        width: 100%;
        min-height: 300px;
        padding: var(--space-md);
        border: none;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        resize: vertical;
        background: var(--color-surface);
        color: var(--color-text);
    }

    .sql-editor:focus {
        outline: none;
        background: var(--color-bg);
    }

    .editor-controls {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>SQL Query Editor</h2>
        <p class="text-sm text-muted mt-md">Execute SQL queries against your PostgreSQL database</p>
    </div>

    <div class="editor-section">
        <form id="query-form"
              hx-post="/api/query/execute"
              hx-target="#query-results"
              hx-swap="innerHTML"
              hx-indicator="#query-spinner">
            <div class="sql-editor-wrapper">
                <textarea id="sql-input"
                          name="query"
                          class="sql-editor"
                          placeholder="SELECT * FROM information_schema.tables WHERE table_schema = 'public' LIMIT 10;"></textarea>
            </div>

            <div class="editor-controls mt-md">
                <button type="submit" class="btn btn-primary">
                    <span>â–¶</span>
                    <span>Execute Query</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearEditor()">
                    <span>âŸ²</span>
                    <span>Clear</span>
                </button>
                <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">
                    <span>ðŸ“‹</span>
                    <span>Copy</span>
                </button>
                <div class="spinner htmx-indicator" id="query-spinner" style="margin-left: var(--space-md);"></div>
            </div>
        </form>
    </div>

    <div class="mt-lg">
        <h3 class="mb-md">Results</h3>
        <div id="query-results">
            <p class="text-muted">Execute a query to see results here.</p>
        </div>
    </div>
</div>

<script>
    function clearEditor() {
        document.getElementById('sql-input').value = '';
        document.getElementById('sql-input').focus();
    }

    function copyToClipboard() {
        const textarea = document.getElementById('sql-input');
        textarea.select();
        document.execCommand('copy');
        
        // Show feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span>âœ“</span><span>Copied!</span>';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    }

    // Syntax highlighting integration
    document.addEventListener('htmx:afterSettle', function(evt) {
        if (evt.detail.target.id === 'query-results' && window.Prism) {
            Prism.highlightAllUnder(evt.detail.target);
        }
    });
</script>
{% endblock %}
