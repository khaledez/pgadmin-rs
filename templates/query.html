{% extends "base.html" %}

{% block title %}Query Editor - pgAdmin-rs{% endblock %}

{% block head %}
<style>
    .query-container {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: var(--space-lg);
        height: calc(100vh - 150px);
    }

    @media (max-width: 1024px) {
        .query-container {
            grid-template-columns: 1fr;
            height: auto;
        }
        
        .query-history-panel {
            max-height: 300px;
        }
    }

    .editor-section {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        margin-bottom: var(--space-lg);
    }

    .sql-editor-wrapper {
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .sql-editor {
        width: 100%;
        min-height: 300px;
        padding: var(--space-md);
        border: none;
        font-family: var(--font-mono);
        font-size: 0.875rem;
        resize: vertical;
        background: var(--color-surface);
        color: var(--color-text);
    }

    .sql-editor:focus {
        outline: none;
        background: var(--color-bg);
    }

    .editor-controls {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
    }

    .main-editor {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    .editor-card {
        flex: 0 0 auto;
    }

    .results-card {
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }

    .results-card .card {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .results-card .card-body {
        flex: 1;
        overflow: auto;
    }

    .dropdown-menu {
        position: relative;
        display: inline-block;
    }

    .dropdown-toggle {
        cursor: pointer;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background: var(--color-surface);
        min-width: 160px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: var(--space-xs) 0;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        z-index: 10;
        top: 100%;
        left: 0;
        margin-top: 4px;
    }

    .dropdown-menu:hover .dropdown-content {
        display: block;
    }

    .dropdown-item {
        display: block;
        width: 100%;
        padding: var(--space-sm) var(--space-md);
        text-align: left;
        border: none;
        background: transparent;
        color: var(--color-text);
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.2s;
    }

    .dropdown-item:hover {
        background: var(--color-hover);
    }
</style>
{% endblock %}

{% block content %}
<div class="query-container">
    <div class="main-editor">
        <div class="card editor-card">
            <div class="card-header">
                <h2>SQL Query Editor</h2>
                <p class="text-sm text-muted mt-md">Execute SQL queries against your PostgreSQL database</p>
            </div>

            <div class="editor-section">
                <form id="query-form"
                      hx-post="/api/query/execute"
                      hx-target="#query-results"
                      hx-swap="innerHTML"
                      hx-indicator="#query-spinner">
                    <div class="sql-editor-wrapper">
                        <textarea id="sql-input"
                                  name="query"
                                  class="sql-editor"
                                  placeholder="SELECT * FROM information_schema.tables WHERE table_schema = 'public' LIMIT 10;"></textarea>
                    </div>

                    <div class="editor-controls mt-md">
                        <button type="submit" class="btn btn-primary">
                            <span>‚ñ∂</span>
                            <span>Execute Query</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearEditor()">
                            <span>‚ü≤</span>
                            <span>Clear</span>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="copyToClipboard()">
                            <span>üìã</span>
                            <span>Copy</span>
                        </button>
                        <div class="dropdown-menu">
                            <button type="button" class="btn btn-secondary dropdown-toggle">
                                <span>‚¨áÔ∏è</span>
                                <span>Export</span>
                            </button>
                            <div class="dropdown-content">
                                <button type="button" class="dropdown-item" onclick="exportResults('csv')">
                                    üìä CSV
                                </button>
                                <button type="button" class="dropdown-item" onclick="exportResults('json')">
                                    {} JSON
                                </button>
                                <button type="button" class="dropdown-item" onclick="exportResults('sql')">
                                    üíæ SQL
                                </button>
                            </div>
                        </div>
                        <div class="spinner htmx-indicator" id="query-spinner" style="margin-left: var(--space-md);"></div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card results-card">
            <div class="card-header">
                <h3 class="mb-0">Results</h3>
            </div>
            <div class="card-body">
                <div id="query-results">
                    <p class="text-muted">Execute a query to see results here.</p>
                </div>
            </div>
        </div>
    </div>

    <aside>
        {% include "components/query-history.html" %}
    </aside>
</div>

<script>
    function clearEditor() {
        document.getElementById('sql-input').value = '';
        document.getElementById('sql-input').focus();
    }

    function copyToClipboard() {
        const textarea = document.getElementById('sql-input');
        textarea.select();
        try {
            document.execCommand('copy');
            ToastManager.success('Query copied to clipboard!', 2000);
        } catch (err) {
            ToastManager.error('Failed to copy query');
        }
    }

    function exportResults(format) {
        const query = document.getElementById('sql-input').value.trim();
        
        if (!query) {
            ToastManager.error('No query to export');
            return;
        }

        // Create a form and submit it to trigger download
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/query/export';
        
        const queryInput = document.createElement('input');
        queryInput.type = 'hidden';
        queryInput.name = 'query';
        queryInput.value = query;
        
        const formatInput = document.createElement('input');
        formatInput.type = 'hidden';
        formatInput.name = 'format';
        formatInput.value = format;
        
        form.appendChild(queryInput);
        form.appendChild(formatInput);
        document.body.appendChild(form);
        
        form.submit();
        document.body.removeChild(form);
        
        ToastManager.success('Exporting as ' + format.toUpperCase() + '...', 2000);
    }

    // Syntax highlighting integration
    document.addEventListener('htmx:afterSettle', function(evt) {
        if (evt.detail.target.id === 'query-results' && window.Prism) {
            Prism.highlightAllUnder(evt.detail.target);
        }
    });
</script>
{% endblock %}
