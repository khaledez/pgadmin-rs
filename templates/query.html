{% extends "base.html" %}

{% block title %}Query Editor - pgAdmin-rs{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-4 h-full">
    <!-- Main Editor Area -->
    <div class="flex-1 flex flex-col gap-4 min-w-0">
        <!-- SQL Editor Card -->
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="card-title text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-accent">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
                        </svg>
                        SQL Query Editor
                    </h2>
                    <span class="text-xs text-base-content/50">Ctrl+Enter to execute</span>
                </div>

                <form id="query-form"
                      hx-post="/api/query/execute"
                      hx-target="#query-results"
                      hx-swap="innerHTML"
                      hx-indicator="#query-spinner">
                    <textarea id="sql-input"
                              name="query"
                              class="textarea textarea-bordered font-mono text-sm w-full bg-base-200"
                              placeholder="SELECT * FROM information_schema.tables WHERE table_schema = 'public' LIMIT 10;"
                              rows="8"></textarea>

                    <div class="flex flex-wrap items-center gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.986V5.653z" />
                            </svg>
                            Execute
                        </button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="clearEditor()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" />
                            </svg>
                            Clear
                        </button>
                        <button type="button" class="btn btn-ghost btn-sm" onclick="copyToClipboard()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                            </svg>
                            Copy
                        </button>
                        
                        <!-- Export Dropdown -->
                        <div class="dropdown dropdown-end">
                            <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                </svg>
                                Export
                            </div>
                            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-40 p-2 shadow-lg border border-base-300">
                                <li><a onclick="exportResults('csv')">CSV</a></li>
                                <li><a onclick="exportResults('json')">JSON</a></li>
                                <li><a onclick="exportResults('sql')">SQL</a></li>
                            </ul>
                        </div>

                        <span class="loading loading-spinner loading-sm htmx-indicator" id="query-spinner"></span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Card -->
        <div class="card bg-base-100 shadow-sm flex-1 min-h-0">
            <div class="card-body p-4 flex flex-col">
                <h3 class="card-title text-sm mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
                    </svg>
                    Results
                </h3>
                <div id="query-results" class="flex-1 overflow-auto">
                    <div class="flex flex-col items-center justify-center h-full text-base-content/50">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 mb-2 opacity-30">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 00-1.883 2.542l.857 6a2.25 2.25 0 002.227 1.932H19.05a2.25 2.25 0 002.227-1.932l.857-6a2.25 2.25 0 00-1.883-2.542m-16.5 0V6A2.25 2.25 0 016 3.75h3.879a1.5 1.5 0 011.06.44l2.122 2.12a1.5 1.5 0 001.06.44H18A2.25 2.25 0 0120.25 9v.776" />
                        </svg>
                        <p class="text-sm">Execute a query to see results</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query History Sidebar -->
    <aside class="lg:w-72 flex-shrink-0">
        {% include "components/query-history.html" %}
    </aside>
</div>

<script>
    function clearEditor() {
        document.getElementById('sql-input').value = '';
        document.getElementById('sql-input').focus();
    }

    function copyToClipboard() {
        const textarea = document.getElementById('sql-input');
        textarea.select();
        try {
            navigator.clipboard.writeText(textarea.value);
            if (window.ToastManager) {
                ToastManager.success('Query copied to clipboard!', 2000);
            }
        } catch (err) {
            if (window.ToastManager) {
                ToastManager.error('Failed to copy query');
            }
        }
    }

    function exportResults(format) {
        const query = document.getElementById('sql-input').value.trim();
        
        if (!query) {
            if (window.ToastManager) {
                ToastManager.error('No query to export');
            }
            return;
        }

        // Create a form and submit it to trigger download
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/api/query/export';
        
        const queryInput = document.createElement('input');
        queryInput.type = 'hidden';
        queryInput.name = 'query';
        queryInput.value = query;
        
        const formatInput = document.createElement('input');
        formatInput.type = 'hidden';
        formatInput.name = 'format';
        formatInput.value = format;
        
        form.appendChild(queryInput);
        form.appendChild(formatInput);
        document.body.appendChild(form);
        
        form.submit();
        document.body.removeChild(form);
        
        if (window.ToastManager) {
            ToastManager.success('Exporting as ' + format.toUpperCase() + '...', 2000);
        }
    }

    // Keyboard shortcut: Ctrl/Cmd + Enter to execute
    document.getElementById('sql-input').addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('query-form').dispatchEvent(new Event('submit', { bubbles: true }));
        }
    });
</script>
{% endblock %}
