{% extends "base.html" %}

{% block title %}Dashboard - pgAdmin-rs{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div>
            <h2>Database Dashboard</h2>
            <p class="text-sm text-muted">Real-time PostgreSQL metrics and insights</p>
        </div>
        <button class="btn btn-secondary" onclick="window.location.reload()">
            <span>üîÑ</span>
            <span>Refresh</span>
        </button>
    </div>

    <!-- Metrics Grid -->
    <div id="metrics-grid"
         class="metrics-grid"
         hx-get="/api/stats/overview"
         hx-trigger="load, every 30s"
         hx-swap="innerHTML">
        <div class="metric-card">
            <div class="metric-icon">üíæ</div>
            <div class="metric-content">
                <div class="metric-label">Database Size</div>
                <div class="metric-value">...</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üìä</div>
            <div class="metric-content">
                <div class="metric-label">Total Tables</div>
                <div class="metric-value">...</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">üîå</div>
            <div class="metric-content">
                <div class="metric-label">Active Connections</div>
                <div class="metric-value">...</div>
            </div>
        </div>

        <div class="metric-card">
            <div class="metric-icon">‚ö°</div>
            <div class="metric-content">
                <div class="metric-label">Cache Hit Ratio</div>
                <div class="metric-value">...</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Quick Actions -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Quick Actions</h3>
            </div>
            <div class="dashboard-card-body">
                <div class="action-buttons">
                    <a href="/query" class="action-btn">
                        <div class="action-icon">‚ö°</div>
                        <div class="action-content">
                            <div class="action-title">Query Editor</div>
                            <div class="action-desc">Execute SQL queries</div>
                        </div>
                    </a>
                    <a href="/browser" class="action-btn">
                        <div class="action-icon">üìÅ</div>
                        <div class="action-content">
                            <div class="action-title">Schema Browser</div>
                            <div class="action-desc">Browse database objects</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Queries -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Recent Queries</h3>
                <a href="/query" class="text-sm">View all</a>
            </div>
            <div id="recent-queries"
                 class="dashboard-card-body"
                 hx-get="/api/query/recent-widget"
                 hx-trigger="load, every 30s"
                 hx-swap="innerHTML">
                <div class="loading-state">Loading recent queries...</div>
            </div>
        </div>

        <!-- Top Tables -->
        <div class="dashboard-card full-width">
            <div class="dashboard-card-header">
                <h3>Top Tables by Size</h3>
            </div>
            <div id="top-tables"
                 class="dashboard-card-body"
                 hx-get="/api/stats/table-stats-widget"
                 hx-trigger="load, every 60s"
                 hx-swap="innerHTML">
                <div class="loading-state">Loading table statistics...</div>
            </div>
        </div>

        <!-- Performance Indicators -->
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3>Performance</h3>
            </div>
            <div id="performance"
                 class="dashboard-card-body"
                 hx-get="/api/stats/cache-stats-widget"
                 hx-trigger="load, every 30s"
                 hx-swap="innerHTML">
                <div class="loading-state">Loading performance data...</div>
            </div>
        </div>
    </div>
</div>

<style>
.dashboard-container {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.dashboard-header h2 {
    margin: 0;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
}

.metric-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    transition: all 0.2s;
}

.metric-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
}

.metric-icon {
    font-size: 2rem;
    opacity: 0.8;
}

.metric-content {
    flex: 1;
}

.metric-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    font-weight: 500;
    letter-spacing: 0.5px;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 600;
    margin-top: var(--space-xs);
    color: var(--color-text);
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-lg);
}

.dashboard-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
}

.dashboard-card.full-width {
    grid-column: 1 / -1;
}

.dashboard-card-header {
    padding: var(--space-lg);
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--color-surface);
}

.dashboard-card-header h3 {
    margin: 0;
    font-size: 1rem;
}

.dashboard-card-body {
    padding: var(--space-lg);
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.action-btn {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-decoration: none;
    color: var(--color-text);
    transition: all 0.2s;
    background: var(--color-surface);
}

.action-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg);
    transform: translateX(4px);
}

.action-icon {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-border);
    border-radius: var(--radius-md);
}

.action-content {
    flex: 1;
}

.action-title {
    font-weight: 600;
    margin-bottom: var(--space-xs);
}

.action-desc {
    font-size: 0.75rem;
    color: var(--color-text-muted);
}

.loading-state {
    text-align: center;
    padding: var(--space-xl);
    color: var(--color-text-muted);
    font-style: italic;
}

.query-item {
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-border);
}

.query-item:last-child {
    border-bottom: none;
}

.query-text {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text);
    margin-bottom: var(--space-sm);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.query-meta {
    display: flex;
    gap: var(--space-md);
    font-size: 0.7rem;
    color: var(--color-text-muted);
}

.table-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.table-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--color-surface);
    border-radius: var(--radius-sm);
}

.table-name {
    font-family: var(--font-mono);
    font-size: 0.875rem;
}

.table-size {
    font-size: 0.75rem;
    color: var(--color-text-muted);
}

.perf-item {
    display: flex;
    justify-content: space-between;
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--color-border);
}

.perf-item:last-child {
    border-bottom: none;
}

.perf-label {
    font-size: 0.875rem;
    color: var(--color-text-muted);
}

.perf-value {
    font-weight: 600;
    font-size: 1rem;
}

.perf-value.good {
    color: var(--color-success);
}

.perf-value.warning {
    color: var(--color-warning);
}

.perf-value.bad {
    color: var(--color-danger);
}

@media (max-width: 768px) {
    .metrics-grid {
        grid-template-columns: 1fr;
    }

    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'metrics-grid') {
        const cards = event.detail.target.querySelectorAll('.metric-card');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.3s ease-out';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50);
            }, index * 50);
        });
    }
});
</script>
{% endblock %}
